// –§–∞–π–ª: HRVDataManager.swift
import Foundation

/// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –í–°–†.
/// Codable –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –µ–µ –≤ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ–±—Ä–∞—Ç–Ω–æ.
struct HRVResult: Codable {
    let date: Date
    let rmssd: Double
}

/// –≠—Ç–æ—Ç –∫–ª–∞—Å—Å —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏ –∑–∞–≥—Ä—É–∑–∫–æ–π –ò–°–¢–û–†–ò–ò –≤—Å–µ—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π –í–°–†.
class HRVDataManager {
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
    static let shared = HRVDataManager()
    
    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ "–∑–∞–ø–∏—Å–Ω–æ–π –∫–Ω–∏–∂–∫–µ" —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (UserDefaults)
    private let userDefaultsKey = "hrvResultsHistory"

    // –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä, —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ –º–æ–≥ —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä
    private init() {}

    /// –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤ –æ–±—â—É—é –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.
    /// - Parameter rmssd: –ó–Ω–∞—á–µ–Ω–∏–µ RMSSD, –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –ø–æ—Å–ª–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è.
    func saveHRVResult(rmssd: Double) {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π
        let newResult = HRVResult(date: Date(), rmssd: rmssd)
        
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—é —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∏—Å—Ç–æ—Ä–∏—é
        var history = getAllHRVResults()
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–∏–≤–∞ (—á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –±—ã–ª–∏ —Å–≤–µ—Ä—Ö—É)
        history.insert(newResult, at: 0)
        
        // 3. –ö–æ–¥–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –≤ —Ñ–æ—Ä–º–∞—Ç Data –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        if let data = try? JSONEncoder().encode(history) {
            // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
            UserDefaults.standard.set(data, forKey: userDefaultsKey)
            print("üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç HRV (\(rmssd) –º—Å) –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é. –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: \(history.count)")
        }
    }

    /// –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ—Ä–µ–Ω–∏–π –∏–∑ –ø–∞–º—è—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
    /// - Returns: –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –∫–æ–≥–¥–∞-–ª–∏–±–æ —Å–¥–µ–ª–∞–Ω–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π.
    func getAllHRVResults() -> [HRVResult] {
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–∞—à–µ–º—É –∫–ª—é—á—É
        guard let data = UserDefaults.standard.data(forKey: userDefaultsKey) else {
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
            return []
        }
        
        // 2. –î–µ–∫–æ–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤ [HRVResult]
        let history = try? JSONDecoder().decode([HRVResult].self, from: data)
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, –µ—Å–ª–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
        return history ?? []
    }
    
    /// (–î–ª—è –æ—Ç–ª–∞–¥–∫–∏) –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ—Ä–µ–Ω–∏–π.
    func clearHistory() {
        UserDefaults.standard.removeObject(forKey: userDefaultsKey)
        print("üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏–π –í–°–† –±—ã–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞.")
    }
}
